#!/bin/bash
# Pre-commit hook: Document Guard
# Ensures documentation-first workflow is followed
# Install: cp docs/scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Get staged files
STAGED=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any code files are being committed
CODE_FILES=$(echo "$STAGED" | grep -E '^(code/|worker/|home/|deploy/)' || true)
DOC_FILES=$(echo "$STAGED" | grep -E '^(docs/|CLAUDE\.md)' || true)

# === Check 1: Phase prerequisites ===
# If committing code files, ensure core docs exist
if [ -n "$CODE_FILES" ]; then
    MISSING=""
    [ ! -f "docs/product-design.md" ] && MISSING="$MISSING\n  - docs/product-design.md (Phase 1)"
    [ ! -f "docs/tech-architecture.md" ] && MISSING="$MISSING\n  - docs/tech-architecture.md (Phase 2)"
    [ ! -f "docs/visual-standard.md" ] && MISSING="$MISSING\n  - docs/visual-standard.md (Phase 3)"

    if [ -n "$MISSING" ]; then
        echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${RED}â•‘  âš ï¸  BLOCKED: Missing prerequisite docs  â•‘${NC}"
        echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${RED}Missing:${NC}$MISSING"
        echo ""
        echo -e "Complete Phase 1-3 before writing code."
        echo -e "Run ${GREEN}/new-project${NC} in Claude Code for guided setup."
        echo ""
        echo -e "To bypass (not recommended): ${YELLOW}git commit --no-verify${NC}"
        exit 1
    fi
fi

# === Check 2: Doc update reminder ===
# If code changed but no docs in the commit, warn
if [ -n "$CODE_FILES" ] && [ -z "$DOC_FILES" ]; then
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘  ğŸ“ Reminder: Update documentation?      â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "Code files changed but no docs updated:"
    echo "$CODE_FILES" | head -10 | sed 's/^/  /'
    COUNT=$(echo "$CODE_FILES" | wc -l | tr -d ' ')
    [ "$COUNT" -gt 10 ] && echo "  ... and $((COUNT - 10)) more"
    echo ""
    echo -e "Consider updating:"
    echo -e "  - ${GREEN}docs/project-progress.md${NC}  (phase status)"
    echo -e "  - ${GREEN}docs/product-design.md${NC}   (new features)"
    echo -e "  - ${GREEN}docs/tech-architecture.md${NC} (architecture changes)"
    echo -e "  - ${GREEN}CLAUDE.md${NC}                (key decisions)"
    echo ""
    echo -e "Proceeding in 3 seconds... (Ctrl+C to cancel)"
    sleep 3
fi

# === Check 3: CLAUDE.md exists ===
if [ ! -f "CLAUDE.md" ]; then
    echo -e "${YELLOW}âš ï¸  No CLAUDE.md found. Consider creating one for AI context.${NC}"
fi

exit 0
